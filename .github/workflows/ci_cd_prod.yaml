name: CI/CD Pipeline - PRODUCTION

on:
  push:
    branches:
      - prod

jobs:
  # ETAPA 1: TEST - Ejecuta las pruebas unitarias
  test:
    runs-on: ubuntu-latest
    steps:
    - name: â¬‡ï¸ Checkout del CÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Instalar Dependencias
      run: pip install -r requirements.txt
      
    - name: âš™ï¸ Preparar Modelo y Datos de Prueba (SimulaciÃ³n)
      run: echo "Modelo y datos listos para testing."

    - name: ğŸ§ª Ejecutar Pruebas Unitarias (Pytest)
      run: .

  # ETAPA 2: BUILD/PROMOTE - Construye la imagen Docker y Simula el Despliegue
  build_promote:
    needs: test # Solo se ejecuta si la etapa 'test' fue exitosa
    runs-on: ubuntu-latest
    steps:
    - name: â¬‡ï¸ Checkout del CÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Construir Imagen Docker
      # Usamos una etiqueta final para la rama prod
      run: |
        DOCKER_IMAGE_TAG=mlops-prod:latest
        docker build . -t $DOCKER_IMAGE_TAG
        echo "Imagen Docker construida con Ã©xito: $DOCKER_IMAGE_TAG"
        
    - name: ğŸš€ Simular Despliegue (SimulaciÃ³n de ActualizaciÃ³n de Endpoint)
      # En el ambiente PROD, este paso serÃ­a la actualizaciÃ³n final del servicio.
      run: |
        echo "SimulaciÃ³n de despliegue en el endpoint PROD completada."
        echo "El contenedor final usarÃ­a el comando: docker run -d -e ENVIRONMENT=prod -p 8080:8080 $DOCKER_IMAGE_TAG"