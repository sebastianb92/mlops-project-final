name: CI/CD Pipeline - PRODUCTION

on:
  push:
    branches:
      - prod
  workflow_dispatch: # Permite disparar el workflow manualmente si es necesario

jobs:
  # ETAPA 1: TEST - Ejecuta las pruebas unitarias (Sanity Check final)
  test:
    runs-on: ubuntu-latest
    steps:
    - name: ‚¨áÔ∏è Checkout del C√≥digo
      uses: actions/checkout@v4

    - name: üêç Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: üì¶ Instalar Dependencias
      run: pip install -r requirements.txt
      
    - name: ‚öôÔ∏è Preparar Modelo y Datos de Prueba (Simulaci√≥n)
      run: echo "Modelo y datos listos para testing."

    - name: üß™ Ejecutar Pruebas Unitarias (Pytest)
      # CORRECCI√ìN CLAVE: Asegura que Python encuentre el m√≥dulo 'app' y ejecuta pytest
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        pytest tests/test_model.py

  # ETAPA 2: BUILD & PUSH - Construye la imagen Docker y Simula el Despliegue
  build_promote:
    needs: test # Solo se ejecuta si la etapa 'test' fue exitosa
    runs-on: ubuntu-latest
    steps:
    - name: ‚¨áÔ∏è Checkout del C√≥digo
      uses: actions/checkout@v4

    - name: üèóÔ∏è Construir Imagen Docker
      # Usamos una etiqueta final y espec√≠fica (ej. git SHA, timestamp, o simplemente 'latest-prod')
      run: |
        DOCKER_IMAGE_TAG=mlops-prod:${{ github.sha }}
        docker build . -t $DOCKER_IMAGE_TAG
        echo "Imagen Docker construida con √©xito: $DOCKER_IMAGE_TAG"
        
    - name: üöÄ Simular PUSH a Registro de Contenedores
      run: |
        # En un flujo real, aqu√≠ se har√≠a 'docker push' a Docker Hub, GCR, o ECR.
        echo "Simulaci√≥n de push de imagen: mlops-prod:${{ github.sha }}"

    - name: üåê Simular Despliegue FINAL a PROD
      # En el ambiente PROD, este paso ser√≠a la actualizaci√≥n final del servicio.
      run: |
        DOCKER_IMAGE_TAG=mlops-prod:${{ github.sha }}
        echo "--- DESPLIEGUE FINAL A PRODUCCI√ìN INICIADO ---"
        echo "Actualizando el servicio PROD con la imagen: ${DOCKER_IMAGE_TAG}"
        echo "El contenedor final usar√≠a el comando: docker run -d -e ENVIRONMENT=prod -p 8080:8080 $DOCKER_IMAGE_TAG"
        echo "‚úÖ Despliegue a Producci√≥n (PROD) completado con √©xito."