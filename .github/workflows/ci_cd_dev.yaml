name: CI/CD Pipeline - DEVELOPMENT

on:
  push:
    branches:
      - dev

jobs:
  # ETAPA 1: TEST - Ejecuta las pruebas unitarias
  test:
    runs-on: ubuntu-latest
    steps:
    - name: ‚¨áÔ∏è Checkout del C√≥digo
      uses: actions/checkout@v4

    - name: üêç Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: üì¶ Instalar Dependencias
      run: pip install -r requirements.txt
      
    - name: ‚öôÔ∏è Preparar Modelo y Datos de Prueba (Simulaci√≥n)
      run: |
        # Asumiendo que mobilenetv2-7.onnx est√° disponible en el runner (por LFS o un paso anterior real)
        echo "Modelo y datos listos para testing."

    - name: üß™ Ejecutar Pruebas Unitarias (Pytest)
      # CORRECCI√ìN CLAVE: Esto soluciona el error de 'ModuleNotFoundError'
      # y el error de 'filename argument required' al usar '.' incorrectamente.
      run: |
        # A√±ade el directorio actual al path de Python para que pueda encontrar 'app.download_model'
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        pytest tests/test_model.py

  # ETAPA 2: BUILD/PROMOTE - Construye la imagen Docker
  build_promote:
    needs: test # Solo se ejecuta si la etapa 'test' fue exitosa
    runs-on: ubuntu-latest
    steps:
    - name: ‚¨áÔ∏è Checkout del C√≥digo
      uses: actions/checkout@v4

    - name: üèóÔ∏è Construir Imagen Docker
      # Nota: La construcci√≥n de la imagen DEBE ejecutar app/download_model.py
      # para obtener el modelo del "bucket" (simulaci√≥n) y meterlo en la imagen.
      run: |
        # Usamos una etiqueta simple para la rama dev (ej: latest-dev)
        DOCKER_IMAGE_TAG=mlops-dev:latest
        docker build . -t $DOCKER_IMAGE_TAG
        echo "Imagen Docker construida con √©xito: $DOCKER_IMAGE_TAG"
        
    - name: üöÄ Simular Despliegue (Simulaci√≥n de Actualizaci√≥n de Endpoint)
      # En un entorno real (ECS/EKS/Cloud Run), este paso
      # har√≠a un push de la imagen y actualizar√≠a el servicio 'dev'
      # para usar la nueva imagen, actualizando el endpoint.
      run: |
        echo "Simulaci√≥n de despliegue en el endpoint DEV completada."
        echo "El contenedor final usar√≠a el comando: docker run -d -e ENVIRONMENT=dev -p 8080:8080 $DOCKER_IMAGE_TAG"